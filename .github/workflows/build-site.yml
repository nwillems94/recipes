name: Build and deploy to GitHub Pages with Jekyll

on:
  push:
    branches:
      - main

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages


# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Scrape job
  scrape:
    if: contains(join(github.event.head_commit.added, github.event.head_commit.modified), '.md')
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install recipe-scrapers

      - name: Identify valid recipe files
        run: |
          FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '\.md$')
          echo "LINKS_BY_FILE = {" > ./.github/filtered_links.py
          for file in $FILES; do
            # Extract non-YAML body (everything after second --- except empty lines)
            body=$(awk 'f{print} /^---/{c++} c==2{f=1}' "$file" | sed '/^$/d')

            # make sure there nothing besides the link
            if [[ -n "${body//\<*\>/}" ]]; then
              continue
            fi

            link=$(echo $body | sed 's/[<>]//g')
            
            # validate link (excluding YouTube/Instagram) and write to file
            if [[ "$link" =~ ^https?:// ]]; then
                echo "    \"$file\": \"$link\"," >> ./.github/filtered_links.py
            fi
          done
          echo "}" >> ./.github/filtered_links.py

      - name: Scrape and update files
        run: |
          python ./.github/scrape_and_update.py

      - name: Commit to review branch
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git checkout -B scraped-recipes
          git add **/*.md
          # Only commit and push if there are staged changes. 
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Scraped recipe data and updated files"
            git push origin scraped-recipes --force
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  # Update the index and service worker
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Generate index.html
        run: bash ./.github/generate_index.sh

      - name: Update sw.js
        run: bash ./.github/update-sw.sh

      - name: Commit and push changes
        run: |
          VERSION=$(grep "var VERSION" sw.js | sed -E "s/.*'version_([0-9]+)'.*/\1/")
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add index.html sw.js
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto update index and sw.js to ${VERSION}"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build job
  build:
    needs: [scrape, update]
    if: always()
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download minima theme
        run: |
          wget -O _sass/solarized.scss https://raw.githubusercontent.com/jekyll/minima/refs/heads/master/_sass/minima/skins/solarized.scss
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
